# 트랜잭셔널 아웃박스 패턴(Transactional Outbox Pattern)

## 1. 개요
> 트랜잭셔널 아웃박스 패턴은 **데이터베이스 트랜잭션과 비동기 이벤트 발행을 일관되게 유지**하기 위한 패턴이다.  
마이크로서비스 환경에서 특정 이벤트가 발생하면, 이를 메시지 브로커(Kafka, RabbitMQ 등)를 통해 다른 서비스로 전달해야 하는 경우가 많다.  
하지만 **트랜잭션과 메시지 발행을 동시에 처리하다가 하나만 성공하고 다른 하나는 실패**하는 문제가 발생할 수 있다.  
이 패턴은 이를 해결하기 위해 **아웃박스 테이블(Outbox Table)** 을 활용한다.

---

## 2. 동작 방식
1. **트랜잭션 내에서 이벤트 저장**
    - 서비스에서 DB에 데이터를 저장할 때, **같은 트랜잭션 안에서** 아웃박스 테이블에 이벤트를 함께 저장한다.
    - 데이터 저장과 이벤트 저장이 하나의 트랜잭션으로 묶이므로, 둘 중 하나라도 실패하면 롤백된다.

2. **별도의 프로세스에서 이벤트 발행**
    - 백그라운드에서 실행되는 **폴링 프로세스 (Polling Process) 또는 CDC(Change Data Capture) 프로세스**가 주기적으로 아웃박스 테이블을 확인한다.
    - 새로운 이벤트가 발견되면 메시지 브로커(Kafka, RabbitMQ 등)로 발행한다.

3. **발행 완료 후 정리**
    - 이벤트가 정상적으로 발행되면, 해당 이벤트를 아웃박스 테이블에서 삭제하거나 상태를 업데이트한다.

---

## 3. 장점
✅ **트랜잭션 일관성 보장** - DB 저장과 이벤트 발행이 한 트랜잭션에서 처리되므로, 하나만 성공하는 문제가 발생하지 않는다.

✅ **메시지 유실 방지** - 이벤트가 DB에 먼저 저장되므로, 메시지 브로커에 보내기 전에 서버가 중단되더라도 손실되지 않는다.

✅ **재처리 가능** - 메시지 발행이 실패하더라도, 폴링 프로세스가 다시 시도할 수 있다.

✅ **메시지 브로커의 종류에 의존하지 않음** - Kafka, RabbitMQ 등 다양한 메시지 브로커와 연동 가능하다.

---

## 4. 단점 및 고려 사항
⚠️ **추가적인 테이블 및 관리 필요** - 아웃박스 테이블을 주기적으로 청소해야 하며, 이를 위한 배치 작업이 필요하다.

⚠️ **폴링 방식의 부하**
- 주기적으로 테이블을 조회하는 폴링 방식은 데이터가 많아질수록 부담이 될 수 있다.
- 이를 해결하기 위해 CDC(Change Data Capture) 방식을 사용하기도 한다.

⚠️ **중복 이벤트 처리 가능성** - 동일한 이벤트가 여러 번 발행될 수 있으므로, **이벤트 핸들러에서 멱등성(Idempotency)을 보장해야 한다.**

---
### 예시

### 1. 문제상황
```java
@Transactional
public void propagateSample() {
   Product product = new Product("신규 상품");
   productRepository.save(product);
   eventPublisher.propagate(new NewProductEvent(product.getId()));
}
```
1. 이벤트 발행까지 완료하여 트랜잭션이 종료되었으나, 실제로 이벤트가 제대로 전달되지 않았을 수 있음.
2. 이벤트가 제대로 발행되었으나, 트랜잭션이 롤백되어 정합성 문제 발생할 수 있음.

### 2. 해결

```java
@Transactional
public void propagateSample() {
   Product product = new Product("신규 상품");
   productRepository.save(product);
   productOutboxRepository.save(new ProductEvent(product.getId()));
}
```

---

## 아웃박스란?
> **아웃박스(Outbox)** 는 **발송 대기 중인 메시지를 임시로 저장하는 공간**을 의미한다.  
이 개념은 이메일 시스템에서도 사용되며, 사용자가 메일을 보내면 **즉시 전송되지 않고 "보낼 편지함(Outbox)"에 먼저 저장**되는 방식과 유사하다.  
